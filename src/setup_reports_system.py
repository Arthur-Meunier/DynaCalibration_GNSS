# setup_reports_system.py
# Script d'installation et configuration du syst√®me de rapports

import os
import sys
import subprocess
from pathlib import Path
import json

def check_and_install_dependencies():
    """V√©rifie et installe les d√©pendances requises"""
    print("üîç V√©rification des d√©pendances...")
    
    required_packages = [
        'reportlab',
        'matplotlib', 
        'pillow',  # Pour le traitement d'images
    ]
    
    missing_packages = []
    
    for package in required_packages:
        try:
            __import__(package)
            print(f"‚úÖ {package} - OK")
        except ImportError:
            missing_packages.append(package)
            print(f"‚ùå {package} - MANQUANT")
    
    if missing_packages:
        print(f"\nüì¶ Installation des packages manquants: {', '.join(missing_packages)}")
        
        for package in missing_packages:
            try:
                subprocess.check_call([sys.executable, '-m', 'pip', 'install', package])
                print(f"‚úÖ {package} install√©")
            except subprocess.CalledProcessError as e:
                print(f"‚ùå Erreur installation {package}: {e}")
                return False
    
    print("üéâ Toutes les d√©pendances sont install√©es !")
    return True

def create_directory_structure(base_path):
    """Cr√©e la structure de r√©pertoires pour le syst√®me"""
    print("üìÅ Cr√©ation de la structure de r√©pertoires...")
    
    directories = [
        "core/reports",
        "core/logs", 
        "logs",
        "reports/output",
        "reports/templates",
        "reports/assets"
    ]
    
    base = Path(base_path)
    
    for dir_path in directories:
        full_path = base / dir_path
        full_path.mkdir(parents=True, exist_ok=True)
        print(f"‚úÖ {full_path}")
    
    # Cr√©er les fichiers __init__.py
    init_files = [
        "core/__init__.py",
        "core/reports/__init__.py", 
        "core/logs/__init__.py"
    ]
    
    for init_file in init_files:
        init_path = base / init_file
        if not init_path.exists():
            init_path.touch()
            print(f"‚úÖ {init_path}")

def create_config_file(base_path):
    """Cr√©e le fichier de configuration par d√©faut"""
    print("‚öôÔ∏è Cr√©ation du fichier de configuration...")
    
    config = {
        "reports": {
            "output_directory": "reports/output",
            "templates_directory": "reports/templates", 
            "assets_directory": "reports/assets",
            "default_format": "PDF",
            "default_style": "professional",
            "auto_open_after_generation": True,
            "include_charts_by_default": True,
            "include_logs_by_default": True,
            "max_log_entries_in_report": 100
        },
        "logging": {
            "base_directory": "logs",
            "max_memory_cache": 1000,
            "auto_archive_days": 30,
            "log_levels": ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"],
            "session_timeout_minutes": 60
        },
        "company": {
            "default_name": "Soci√©t√© de Calibration",
            "default_address": "",
            "default_phone": "",
            "default_email": "",
            "default_website": "",
            "logo_path": ""
        },
        "advanced": {
            "pdf_compression": True,
            "image_dpi": 150,
            "chart_size_inches": [8, 6],
            "parallel_generation": False
        }
    }
    
    config_path = Path(base_path) / "config" / "reports_config.json"
    config_path.parent.mkdir(exist_ok=True)
    
    with open(config_path, 'w', encoding='utf-8') as f:
        json.dump(config, f, indent=2, ensure_ascii=False)
    
    print(f"‚úÖ Configuration cr√©√©e: {config_path}")
    return config_path

def create_example_usage(base_path):
    """Cr√©e des exemples d'utilisation"""
    print("üìù Cr√©ation des exemples d'utilisation...")
    
    example_code = '''# exemple_utilisation_rapports.py
"""
Exemples d'utilisation du syst√®me de rapports
"""

import sys
from pathlib import Path

# Ajouter le r√©pertoire src au path
sys.path.insert(0, str(Path(__file__).parent / "src"))

def exemple_rapport_simple():
    """Exemple de g√©n√©ration d'un rapport simple"""
    from core.reports.report_generator import generate_quick_report
    from core.project_manager import ProjectManager
    
    # Charger un projet
    pm = ProjectManager.instance()
    
    # G√©n√©rer un rapport rapide
    success = generate_quick_report(
        pm, 
        "rapport_exemple.pdf", 
        "complete"
    )
    
    if success:
        print("‚úÖ Rapport g√©n√©r√©: rapport_exemple.pdf")
    else:
        print("‚ùå Erreur g√©n√©ration rapport")

def exemple_rapport_personnalise():
    """Exemple de rapport avec configuration personnalis√©e"""
    from core.reports.report_generator import ReportGenerator, ReportConfig, ReportData
    from core.project_manager import ProjectManager
    from core.logs.log_manager import get_log_manager
    
    # Configuration personnalis√©e
    config = ReportConfig(
        template_type="complete",
        include_charts=True,
        include_logs=True,
        include_matrices=True,
        chart_style="professional",
        company_info={
            'name': 'Ma Soci√©t√© de Calibration',
            'address': '123 Rue de la Navigation, 75001 Paris',
            'phone': '+33 1 23 45 67 89',
            'email': 'contact@calibration.fr'
        }
    )
    
    # R√©cup√©rer les donn√©es du projet
    pm = ProjectManager.instance()
    current_project = pm.get_current_project()
    
    if not current_project:
        print("‚ùå Aucun projet charg√©")
        return
    
    # R√©cup√©rer les logs
    log_manager = get_log_manager()
    logs_data = log_manager.export_logs_for_report() if log_manager else []
    
    # Pr√©parer les donn√©es du rapport
    report_data = ReportData(
        project_metadata=current_project.get('metadata', {}),
        workflow_status=current_project.get('workflow_status', {}),
        qc_metrics=current_project.get('qc_metrics', {}),
        sensor_data=current_project.get('observation_sensors', []),
        calculation_results=current_project.get('calculations', {}),
        logs_summary=logs_data
    )
    
    # G√©n√©rer le rapport
    generator = ReportGenerator(config)
    success = generator.generate_complete_report(
        report_data, 
        "rapport_personnalise.pdf"
    )
    
    if success:
        print("‚úÖ Rapport personnalis√© g√©n√©r√©: rapport_personnalise.pdf")
    else:
        print("‚ùå Erreur g√©n√©ration rapport personnalis√©")

def exemple_logs():
    """Exemple d'utilisation du syst√®me de logs"""
    from core.logs.log_manager import get_log_manager, log_info, log_user_action
    
    # R√©cup√©rer le log manager
    log_manager = get_log_manager()
    
    # D√©marrer une session pour un projet
    session_id = log_manager.start_project_session("mon_projet_test")
    print(f"Session d√©marr√©e: {session_id}")
    
    # Logger des √©v√©nements
    log_info("D√©but des op√©rations de test")
    log_user_action("Test syst√®me rapports", {"module": "exemple"})
    
    # R√©cup√©rer les logs r√©cents
    recent_logs = log_manager.get_recent_logs(count=10)
    print(f"Logs r√©cents: {len(recent_logs)} entr√©es")
    
    # Statistiques
    stats = log_manager.get_log_statistics()
    print(f"Statistiques: {stats}")
    
    # Terminer la session
    log_manager.end_current_session()

if __name__ == "__main__":
    print("üß™ Tests du syst√®me de rapports")
    print("=" * 50)
    
    print("\\n1Ô∏è‚É£ Test rapport simple")
    try:
        exemple_rapport_simple()
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
    
    print("\\n2Ô∏è‚É£ Test rapport personnalis√©")
    try:
        exemple_rapport_personnalise()
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
    
    print("\\n3Ô∏è‚É£ Test syst√®me de logs")
    try:
        exemple_logs()
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
    
    print("\\n‚úÖ Tests termin√©s")
'''
    
    example_path = Path(base_path) / "exemple_utilisation_rapports.py"
    with open(example_path, 'w', encoding='utf-8') as f:
        f.write(example_code)
    
    print(f"‚úÖ Exemple cr√©√©: {example_path}")

def integrate_with_main_app(base_path):
    """Cr√©e le code d'int√©gration avec l'application principale"""
    print("üîó Cr√©ation du code d'int√©gration...")
    
    integration_code = '''# integration_rapports_main.py
"""
Code d'int√©gration du syst√®me de rapports avec l'application principale
√Ä ajouter dans main.py
"""

def integrate_reports_system():
    """Int√®gre le syst√®me de rapports dans l'application"""
    
    # 1. Initialiser le syst√®me de logs
    from core.logs.log_manager import init_log_manager
    
    # Initialiser avec le r√©pertoire de logs du projet
    log_manager = init_log_manager("logs")
    print("[OK] Syst√®me de logs initialis√©")
    
    # 2. Int√©grer avec la Page Accueil Enhanced
    def enhance_home_page(home_widget, project_manager):
        """Am√©liore la page d'accueil avec les fonctionnalit√©s de rapports"""
        from app.gui.reports_integration import add_reports_section_to_home, setup_logging_for_project
        
        # Ajouter les fonctionnalit√©s de rapports
        add_reports_section_to_home(home_widget)
        
        # Configurer les logs pour le projet
        setup_logging_for_project(project_manager)
        
        print("[OK] Page d'accueil am√©lior√©e avec syst√®me de rapports")
    
    return enhance_home_page

# Exemple d'utilisation dans MainWindow.__init__()
def exemple_integration_main_window():
    """
    Exemple d'int√©gration dans la classe MainWindow
    """
    
    # Dans MainWindow.__init__(), apr√®s la cr√©ation de la page d'accueil :
    
    # Int√©grer le syst√®me de rapports
    enhance_home_page = integrate_reports_system()
    
    # Am√©liorer la page d'accueil
    enhance_home_page(self.page_home, self.project_manager)
    
    # D√©marrer une session de logs pour l'application
    from core.logs.log_manager import get_log_manager, log_info
    
    log_manager = get_log_manager()
    log_manager.start_project_session("application_session")
    log_info("Application d√©marr√©e", module="main", user_action=True)

# Code √† ajouter dans MainWindow.closeEvent()
def exemple_fermeture_application():
    """Code √† ajouter lors de la fermeture de l'application"""
    
    from core.logs.log_manager import get_log_manager, log_info
    
    log_manager = get_log_manager()
    if log_manager:
        log_info("Fermeture application", module="main", user_action=True)
        log_manager.end_current_session()
'''
    
    integration_path = Path(base_path) / "integration_rapports_main.py"
    with open(integration_path, 'w', encoding='utf-8') as f:
        f.write(integration_code)
    
    print(f"‚úÖ Int√©gration cr√©√©e: {integration_path}")

def create_quick_test():
    """Cr√©e un test rapide du syst√®me"""
    print("üß™ Cr√©ation du test rapide...")
    
    test_code = '''# test_rapide_rapports.py
"""
Test rapide du syst√®me de rapports - Version autonome
"""

import sys
from pathlib import Path
import tempfile

# Ajouter le r√©pertoire src au path
sys.path.insert(0, str(Path(__file__).parent / "src"))

def test_import_modules():
    """Test d'import des modules"""
    print("üì¶ Test imports...")
    
    try:
        from core.reports.report_generator import ReportGenerator, ReportConfig, ReportData
        print("‚úÖ report_generator")
    except ImportError as e:
        print(f"‚ùå report_generator: {e}")
        return False
    
    try:
        from core.logs.log_manager import ProjectLogManager, get_log_manager
        print("‚úÖ log_manager")
    except ImportError as e:
        print(f"‚ùå log_manager: {e}")
        return False
    
    try:
        import reportlab
        print("‚úÖ reportlab")
    except ImportError as e:
        print(f"‚ùå reportlab: {e}")
        return False
    
    try:
        import matplotlib
        print("‚úÖ matplotlib")
    except ImportError as e:
        print(f"‚ùå matplotlib: {e}")
        return False
    
    return True

def test_report_generation():
    """Test de g√©n√©ration de rapport"""
    print("\\nüìÑ Test g√©n√©ration rapport...")
    
    try:
        from core.reports.report_generator import ReportGenerator, ReportConfig, ReportData
        
        # Donn√©es de test
        test_project_data = {
            'metadata': {
                'vessel': 'Navire Test',
                'company': 'Soci√©t√© Test',
                'engineer': 'Ing√©nieur Test',
                'created': '2025-01-15T10:00:00Z',
                'last_modified': '2025-01-15T15:30:00Z',
                'description': 'Projet de test pour le syst√®me de rapports'
            },
            'workflow_status': {
                'dimcon': {'progress': 100, 'completed': True},
                'gnss': {'progress': 75, 'completed': False},
                'observation': {'progress': 50, 'completed': False},
                'qc': {'progress': 0, 'completed': False}
            },
            'qc_metrics': {
                'global_score': 62.5,
                'gnss_score': 85.0,
                'sensors_score': 40.0
            },
            'observation_sensors': [
                {'id': 'MRU_Test', 'type': 'MRU'},
                {'id': 'Compas_Test', 'type': 'Compas'}
            ]
        }
        
        # Pr√©parer les donn√©es du rapport
        report_data = ReportData(
            project_metadata=test_project_data['metadata'],
            workflow_status=test_project_data['workflow_status'],
            qc_metrics=test_project_data['qc_metrics'],
            sensor_data=test_project_data['observation_sensors']
        )
        
        # Configuration
        config = ReportConfig(
            template_type="complete",
            include_charts=False,  # D√©sactiver pour √©viter les d√©pendances matplotlib
            include_logs=False
        )
        
        # G√©n√©rer le rapport
        generator = ReportGenerator(config)
        
        with tempfile.NamedTemporaryFile(suffix='.pdf', delete=False) as tmp_file:
            success = generator.generate_complete_report(report_data, tmp_file.name)
            
            if success:
                print(f"‚úÖ Rapport g√©n√©r√©: {tmp_file.name}")
                
                # V√©rifier que le fichier existe et a une taille > 0
                tmp_path = Path(tmp_file.name)
                if tmp_path.exists() and tmp_path.stat().st_size > 0:
                    print(f"‚úÖ Fichier valide: {tmp_path.stat().st_size} bytes")
                    return True
                else:
                    print("‚ùå Fichier invalide ou vide")
                    return False
            else:
                print("‚ùå √âchec g√©n√©ration rapport")
                return False
    
    except Exception as e:
        print(f"‚ùå Erreur g√©n√©ration: {e}")
        import traceback
        traceback.print_exc()
        return False

def test_log_system():
    """Test du syst√®me de logs"""
    print("\\nüìù Test syst√®me de logs...")
    
    try:
        from core.logs.log_manager import ProjectLogManager, get_log_manager
        
        # Initialiser avec r√©pertoire temporaire
        with tempfile.TemporaryDirectory() as tmp_dir:
            log_manager = ProjectLogManager(tmp_dir)
            
            # D√©marrer une session
            session_id = log_manager.start_project_session("test_project")
            print(f"‚úÖ Session cr√©√©e: {session_id}")
            
            # Ajouter des logs
            log_manager.log_info("Test message INFO")
            log_manager.log_warning("Test message WARNING")
            log_manager.log_user_action("Test action utilisateur", {"test": True})
            
            # R√©cup√©rer les logs
            recent_logs = log_manager.get_recent_logs(count=10)
            print(f"‚úÖ Logs r√©cup√©r√©s: {len(recent_logs)} entr√©es")
            
            # Statistiques
            stats = log_manager.get_log_statistics()
            print(f"‚úÖ Statistiques: {stats.get('total_logs', 0)} logs")
            
            # Terminer la session
            log_manager.end_current_session()
            print("‚úÖ Session termin√©e")
            
            return True
    
    except Exception as e:
        print(f"‚ùå Erreur logs: {e}")
        import traceback
        traceback.print_exc()
        return False

def main():
    """Test principal"""
    print("üß™ TEST RAPIDE - SYST√àME DE RAPPORTS")
    print("=" * 60)
    
    results = []
    
    # Test 1: Imports
    results.append(("Imports modules", test_import_modules()))
    
    # Test 2: G√©n√©ration rapport
    results.append(("G√©n√©ration rapport", test_report_generation()))
    
    # Test 3: Syst√®me logs
    results.append(("Syst√®me logs", test_log_system()))
    
    # R√©sultats
    print("\\n" + "=" * 60)
    print("üìä R√âSULTATS")
    print("=" * 60)
    
    passed = 0
    for test_name, success in results:
        status = "‚úÖ R√âUSSI" if success else "‚ùå √âCHEC"
        print(f"{test_name:<20} {status}")
        if success:
            passed += 1
    
    print("-" * 60)
    print(f"TOTAL: {passed}/{len(results)} tests r√©ussis")
    
    if passed == len(results):
        print("\\nüéâ Tous les tests sont pass√©s !")
        print("üöÄ Le syst√®me de rapports est op√©rationnel !")
    else:
        print(f"\\n‚ö†Ô∏è {len(results) - passed} test(s) ont √©chou√©")
        print("üîß V√©rifiez les erreurs ci-dessus")

if __name__ == "__main__":
    main()
'''
    
    test_path = Path("test_rapide_rapports.py")
    with open(test_path, 'w', encoding='utf-8') as f:
        f.write(test_code)
    
    print(f"‚úÖ Test cr√©√©: {test_path}")

def main():
    """Fonction principale d'installation"""
    print("üöÄ INSTALLATION SYST√àME DE RAPPORTS")
    print("=" * 60)
    print("Installation et configuration du syst√®me de logs/rapports")
    print("pour l'application de calibration")
    print()
    
    # D√©tecter le r√©pertoire de base
    base_path = Path.cwd()
    if (base_path / "src").exists():
        src_path = base_path / "src"
    else:
        src_path = base_path
    
    print(f"üìÅ R√©pertoire de base: {base_path}")
    print(f"üìÅ R√©pertoire src: {src_path}")
    print()
    
    # √âtapes d'installation
    steps = [
        ("V√©rification d√©pendances", lambda: check_and_install_dependencies()),
        ("Structure r√©pertoires", lambda: create_directory_structure(src_path)),
        ("Fichier configuration", lambda: create_config_file(base_path)),
        ("Exemples d'utilisation", lambda: create_example_usage(base_path)),
        ("Code d'int√©gration", lambda: integrate_with_main_app(base_path)),
        ("Test rapide", lambda: create_quick_test())
    ]
    
    results = []
    
    for step_name, step_func in steps:
        print(f"\\n‚öôÔ∏è {step_name}...")
        try:
            result = step_func()
            if result is False:
                print(f"‚ùå √âchec: {step_name}")
                results.append((step_name, False))
            else:
                print(f"‚úÖ Termin√©: {step_name}")
                results.append((step_name, True))
        except Exception as e:
            print(f"‚ùå Erreur {step_name}: {e}")
            results.append((step_name, False))
    
    # R√©sum√© final
    print("\\n" + "=" * 60)
    print("üìä R√âSUM√â INSTALLATION")
    print("=" * 60)
    
    passed = sum(1 for _, success in results if success)
    total = len(results)
    
    for step_name, success in results:
        status = "‚úÖ R√âUSSI" if success else "‚ùå √âCHEC"
        print(f"{step_name:<25} {status}")
    
    print("-" * 60)
    print(f"TOTAL: {passed}/{total} √©tapes r√©ussies")
    
    if passed == total:
        print("\\nüéâ INSTALLATION TERMIN√âE AVEC SUCC√àS !")
        print("\\nüìã PROCHAINES √âTAPES:")
        print("1. Testez le syst√®me: python test_rapide_rapports.py")
        print("2. Int√©grez dans main.py (voir integration_rapports_main.py)")
        print("3. Personnalisez config/reports_config.json")
        print("4. Ajoutez vos templates dans reports/templates/")
        print("\\nüöÄ Le syst√®me de rapports est pr√™t √† l'emploi !")
        
    else:
        print(f"\\n‚ö†Ô∏è {total - passed} √©tape(s) ont √©chou√©")
        print("üîß V√©rifiez les erreurs ci-dessus et relancez l'installation")
        print("üí° Assurez-vous d'avoir les droits d'√©criture dans le r√©pertoire")

if __name__ == "__main__":
    main()